<!DOCTYPE html>
<html lang="hu">
<head>
<meta charset="UTF-8">
<title>F9PSJA IndexedDB</title>
<style>
    body { 
        font-family: Arial, sans-serif; 
        max-width: 1200px; 
        margin: auto; 
        padding: 20px;
        background: #f5f5f5;
    }
    h2 {
        text-align: center;
        background: white;
        padding: 15px;
        border-radius: 8px;
        border: 1px solid #ddd;
    }
    .container {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
    }
    fieldset { 
        background: white;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 15px;
        flex: 1;
    }
    legend {
        font-weight: bold;
        font-size: 16px;
        padding: 0 10px;
    }
    .export-section {
        background: white;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 20px;
    }
    label { display: block; margin-top: 8px; }
    input, select { 
        width: 100%;
        margin: 3px 0 8px 0; 
        padding: 6px;
        border: 1px solid #ccc;
        border-radius: 4px;
        box-sizing: border-box;
    }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    th { background: #eee; }
    .search-label { font-weight: bold; margin-top: 15px; }
    ul { margin: 5px 0; padding-left: 20px; }
</style>
</head>
<body>

<h2>F9PSJA IndexedDB - Tulajdonos & Autó</h2>

<div class="container">

<fieldset>
<legend>Tulajdonos</legend>
<label>Név:</label>
<input id="t_nev" placeholder="Név">
<label>Cím:</label>
<input id="t_cim" placeholder="Cím">
<label>Telefon:</label>
<input id="t_telefon" placeholder="Telefon">
<button onclick="saveOwner()">Tulajdonos hozzáadása</button>

<div class="search-label">Keresés</div>
<input id="t_keres" placeholder="Név" onkeyup="listOwners()">

<div class="search-label">Összes tulajdonos</div>
<div id="tulajLista">Nincs megjeleníthető tulajdonos.</div>
</fieldset>

<fieldset>
<legend>Autó</legend>
<label>Rendszám:</label>
<input id="a_rendszam" placeholder="ABC-123">
<label>Típus:</label>
<input id="a_tipus" placeholder="Toyota">
<label>Szín:</label>
<input id="a_szin" placeholder="kék">
<label>Kor:</label>
<input id="a_kor" placeholder="Év">
<label>Ár:</label>
<input id="a_ar" placeholder="Ft">
<label>Tulaj:</label>
<select id="a_tkod">
    <option value="">Válassz tulajdonost</option>
</select>
<button onclick="saveCar()">Autó hozzáadása</button>

<div class="search-label">Keresés</div>
<input id="a_keres" placeholder="Keresés autók" onkeyup="listCars()">

<div class="search-label">Szűrés</div>
<select id="szures_tkod" onchange="listCars()">
    <option value="">Összes tulajdonos</option>
</select>

<div class="search-label">Autók listája</div>
<div id="autoLista">Nincs megjeleníthető autó.</div>
</fieldset>

</div>

<div class="export-section">
<h3>Adatok mentése és betöltése</h3>
<p>Az export minden tulajdonost és autót egy JSON fájlba ment. Az import betölti a fájl tartalmát és felülírja a jelenlegi adatokat.</p>
<button onclick="exportAllJSON()">Exportálás JSON fájlba</button>
<br><br>
<input type="file" id="importFile" onchange="importAllJSON(event)">
<label for="importFile" style="display:inline; cursor:pointer;">Fájl kiválasztása</label>
<button onclick="document.getElementById('importFile').click()">Nincs fájl kiválasztva</button>
<button onclick="importAllJSON(event)">Importálás JSON-ból</button>
</div>

<script>
let db;

const DB_NAME = "F9PSJA_AutoTulajDB";
const DB_VER = 2;

function initDB() {
    const req = indexedDB.open(DB_NAME, 2);
    req.onupgradeneeded = (e) => {
        db = e.target.result;
        if (!db.objectStoreNames.contains("tulaj")) {
            const tulajStore = db.createObjectStore("tulaj", { keyPath: "tkod", autoIncrement: true });
            tulajStore.createIndex("nev", "nev", { unique: false });
        }
        if (!db.objectStoreNames.contains("auto")) {
            const autoStore = db.createObjectStore("auto", { keyPath: "rendszam" });
            autoStore.createIndex("tkod", "tkod", { unique: false });
            autoStore.createIndex("tipus", "tipus", { unique: false });
            autoStore.createIndex("szin", "szin", { unique: false });
        }
    };
    req.onsuccess = (e) => {
        db = e.target.result;
        refreshOwnerSelects();
        listOwners();
        listCars();
    };
    req.onerror = () => alert("DB hiba");
}

// ----- TULAJDONOS -----
function saveOwner() {
    const nev = document.getElementById("t_nev").value;
    const cim = document.getElementById("t_cim").value;
    const telefon = document.getElementById("t_telefon").value;
    if (!nev) { alert("Név kötelező!"); return; }
    const tx = db.transaction("tulaj", "readwrite");
    const store = tx.objectStore("tulaj");
    store.add({ nev, cim, telefon });
    tx.oncomplete = () => {
        document.getElementById("t_nev").value = "";
        document.getElementById("t_cim").value = "";
        document.getElementById("t_telefon").value = "";
        listOwners();
        refreshOwnerSelects();
    };
}

function listOwners() {
    const keres = document.getElementById("t_keres").value.toLowerCase();
    const tx = db.transaction("tulaj", "readonly");
    const store = tx.objectStore("tulaj");
    const req = store.getAll();
    req.onsuccess = () => {
        let list = req.result.filter(t => t.nev.toLowerCase().includes(keres));
        // Sort by name alphabetically
        list.sort((a, b) => a.nev.localeCompare(b.nev));
        if (list.length === 0) {
            document.getElementById("tulajLista").innerHTML = "Nincs megjeleníthető tulajdonos.";
            return;
        }
        let html = "<ul>";
        list.forEach(t => {
            html += `<li>Tkod: ${t.tkod} – ${t.nev} (${t.cim || ""}, ${t.telefon || ""})</li>`;
        });
        html += "</ul>";
        document.getElementById("tulajLista").innerHTML = html;
    };
}

function refreshOwnerSelects() {
    const tx = db.transaction("tulaj", "readonly");
    const store = tx.objectStore("tulaj");
    const req = store.getAll();
    req.onsuccess = () => {
        let list = req.result;
        // Sort by name alphabetically
        list.sort((a, b) => a.nev.localeCompare(b.nev));
        const aSel = document.getElementById("a_tkod");
        const szSel = document.getElementById("szures_tkod");
        aSel.innerHTML = "";
        szSel.innerHTML = "<option value=''>-- mind --</option>";
        list.forEach(t => {
            const opt1 = document.createElement("option");
            opt1.value = t.tkod;
            opt1.textContent = `${t.tkod} - ${t.nev}`;
            aSel.appendChild(opt1);

            const opt2 = document.createElement("option");
            opt2.value = t.tkod;
            opt2.textContent = `${t.tkod} - ${t.nev}`;
            szSel.appendChild(opt2);
        });
    };
}

// ----- AUTÓ -----
function saveCar() {
    const rendszam = document.getElementById("a_rendszam").value;
    const tipus = document.getElementById("a_tipus").value;
    const szin = document.getElementById("a_szin").value;
    const kor = document.getElementById("a_kor").value;
    const ar = document.getElementById("a_ar").value;
    const tkod = Number.parseInt(document.getElementById("a_tkod").value, 10);

    if (!rendszam || Number.isNaN(tkod)) {
        alert("Rendszám és tulaj kötelező!");
        return;
    }

    const tx = db.transaction("auto", "readwrite");
    const store = tx.objectStore("auto");
    store.put({ rendszam, tipus, szin, kor, ar, tkod });
    tx.oncomplete = () => {
        document.getElementById("a_rendszam").value = "";
        document.getElementById("a_tipus").value = "";
        document.getElementById("a_szin").value = "";
        document.getElementById("a_kor").value = "";
        document.getElementById("a_ar").value = "";
        listCars();
    };
}

function listCars() {
    const keres = document.getElementById("a_keres").value.toLowerCase();
    const sz_tkod = document.getElementById("szures_tkod").value;

    const tx = db.transaction("auto", "readonly");
    const store = tx.objectStore("auto");
    const req = store.getAll();
    req.onsuccess = () => {
        let list = req.result;
        
        // Filter by search term
        list = list.filter(a =>
            (a.rendszam || "").toLowerCase().includes(keres) ||
            (a.tipus || "").toLowerCase().includes(keres) ||
            (a.szin || "").toLowerCase().includes(keres)
        );
        
        // Filter by owner
        if (sz_tkod) {
            list = list.filter(a => String(a.tkod) === sz_tkod);
        }

        // Sort by rendszam
        list.sort((a, b) => (a.rendszam || "").localeCompare(b.rendszam || ""));

        if (list.length === 0) {
            document.getElementById("autoLista").innerHTML = "Nincs megjeleníthető autó.";
            return;
        }

        let html = "<ul>";
        list.forEach(a => {
            html += `<li>${a.rendszam} - ${a.tipus || ""} (${a.szin || ""}, ${a.kor || ""}, ${a.ar || ""} Ft) - Tulaj: ${a.tkod}</li>`;
        });
        html += "</ul>";
        document.getElementById("autoLista").innerHTML = html;
    };
}

// ----- JSON EXPORT/IMPORT -----
function exportAllJSON() {
    const tx = db.transaction(["tulaj", "auto"], "readonly");
    const tulajStore = tx.objectStore("tulaj");
    const autoStore = tx.objectStore("auto");
    
    const tulajReq = tulajStore.getAll();
    const autoReq = autoStore.getAll();
    
    Promise.all([
        new Promise(resolve => tulajReq.onsuccess = () => resolve(tulajReq.result)),
        new Promise(resolve => autoReq.onsuccess = () => resolve(autoReq.result))
    ]).then(([tulajok, autok]) => {
        const data = {
            tulajdonosok: tulajok,
            autok: autok
        };
        const blob = new Blob([JSON.stringify(data, null, 2)], {type:"application/json"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "adatok.json";
        a.click();
    });
}

function importAllJSON(e) {
    const file = e.target ? e.target.files[0] : document.getElementById("importFile").files[0];
    if (!file) {
        alert("Nincs fájl kiválasztva!");
        return;
    }
    
    const reader = new FileReader();
    reader.onload = () => {
        try {
            const data = JSON.parse(reader.result);
            
            // Clear existing data
            const tx = db.transaction(["tulaj", "auto"], "readwrite");
            const tulajStore = tx.objectStore("tulaj");
            const autoStore = tx.objectStore("auto");
            
            tulajStore.clear();
            autoStore.clear();
            
            // Import new data
            if (data.tulajdonosok) {
                data.tulajdonosok.forEach(t => tulajStore.add(t));
            }
            if (data.autok) {
                data.autok.forEach(a => autoStore.put(a));
            }
            
            tx.oncomplete = () => {
                refreshOwnerSelects();
                listOwners();
                listCars();
                alert("Adatok sikeresen importálva!");
            };
        } catch (err) {
            alert("Hibás JSON fájl! " + err.message);
        }
    };
    reader.readAsText(file);
}

initDB();
</script>

</body>
</html>
